<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="profile.css">
</head>
<body>

    <div class="profile-container">
        <div class="exit-icon">
            <a href="index.html" id="exitIcon"><span>&larr;</span></a>
        </div>

        <div class="profile-picture">
            <img id="profile-img" class="editable" src="default-avatar.png" alt="Profile Picture">
            <input type="file" id="profile-pic-upload" accept="image/*" style="display:none;">
        </div>

        <div class="profile-info">
            <input type="text" id="username-input" class="hidden" />
            <h1 id="username" class="editable">Loading...</h1>
            <p id="role"></p>
        </div>

        <div class="profile-actions">
            <button id="message"><span class="icon">‚úâÔ∏è</span> Message</button>
            <button id="add-product"><span class="icon">‚ûï</span> Add Product</button>
            <button id="edit"><span class="icon">üíæ</span> Save</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm";

        // Your Supabase URL and Anon Key
        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener("DOMContentLoaded", async () => {
            const userId = localStorage.getItem("user_id");

            if (!userId) {
                alert("‚ö†Ô∏è No profile found. Redirecting...");
                window.location.href = "store.html";
                return;
            }

            const { data: profile, error } = await supabase
                .from("users")
                .select("*")
                .eq("id", userId)
                .maybeSingle();

            if (error || !profile) {
                alert("‚ö†Ô∏è Error loading profile.");
                return;
            }

            const usernameEl = document.getElementById("username");
            const usernameInput = document.getElementById("username-input");
            const profileImg = document.getElementById("profile-img");

            usernameEl.textContent = `${profile.first_name || "Unknown"} ${profile.last_name || ""}`;
            profileImg.src = profile.avatar_url || "default-avatar.png";
            document.getElementById("role").textContent = `Role: ${profile.role || "Unknown"}`;

            // Enable name editing
            usernameEl.addEventListener("click", () => {
                usernameInput.value = usernameEl.textContent;
                usernameEl.classList.add("hidden");
                usernameInput.classList.remove("hidden");
                usernameInput.focus();
            });

            usernameInput.addEventListener("blur", () => {
                usernameEl.textContent = usernameInput.value;
                usernameEl.classList.remove("hidden");
                usernameInput.classList.add("hidden");
            });

            // Handle profile picture upload
            profileImg.addEventListener("click", () => {
                document.getElementById("profile-pic-upload").click();
            });

            document.getElementById("profile-pic-upload").addEventListener("change", async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const fileExt = file.name.split(".").pop();
                const fileName = `avatars/${userId}.${fileExt}`;

                const { data, error: uploadError } = await supabase
                    .storage
                    .from("avatars")
                    .upload(fileName, file, { upsert: true });

                if (uploadError) {
                    alert("‚ùå Failed to upload avatar.");
                    return;
                }

                const { data: publicUrlData } = supabase
                    .storage
                    .from("avatars")
                    .getPublicUrl(fileName);

                const avatarUrl = publicUrlData.publicUrl;
                profileImg.src = avatarUrl;

                await supabase
                    .from("users")
                    .update({ avatar_url: avatarUrl })
                    .eq("id", userId);

                alert("‚úÖ Profile picture updated!");
            });

            // Save updated name and avatar
            document.getElementById("edit").addEventListener("click", async () => {
                const updatedName = usernameInput.value.trim();
                const [firstName, ...lastName] = updatedName.split(" ");

                const { error } = await supabase
                    .from("users")
                    .update({
                        first_name: firstName || profile.first_name,
                        last_name: lastName.join(" ") || profile.last_name,
                    })
                    .eq("id", userId);

                if (error) {
                    alert("‚ùå Failed to update profile.");
                } else {
                    alert("‚úÖ Profile updated!");
                }
            });
        });
    </script>

</body>
</html>
