<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="profile.css">
</head>
<body>

    <div class="profile-container">
        <div class="exit-icon">
            <a href="index.html" id="exitIcon"><span>&larr;</span></a>
        </div>

        <div class="banner">
            <img id="banner-img" src="image1.jpg" alt="Banner Image">
        </div>

        <div class="profile-picture">
            <img id="profile-img" src="profile-picture.jpg" alt="Profile Picture">
        </div>

        <div class="profile-info">
            <h1 id="username">Loading...</h1>
            <p id="role"></p>
            
            <div class="profile-actions">
                <button id="message"><span class="icon">✉️</span> Message</button>
                <button id="add-product"><span class="icon">➕</span> Add Product</button>
                <button id="edit"><span class="icon">🔧</span> Edit</button>
                <button id="copy-link"><span class="icon">🔗</span> Link</button>
            </div>
        </div>

        <input type="file" id="profile-pic-upload" accept="image/*" style="display:none;">
        <input type="file" id="banner-upload" accept="image/*" style="display:none;">

    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm";

        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const profileImg = document.getElementById("profile-img");
        const profilePicUpload = document.getElementById("profile-pic-upload");
        const bannerImg = document.getElementById("banner-img");
        const bannerUpload = document.getElementById("banner-upload");
        const username = document.getElementById("username");
        const editButton = document.getElementById("edit");

        let editing = false;
        let userId = localStorage.getItem("user_id");

        async function fetchProfile() {
            if (!userId) {
                alert("⚠️ No profile found.");
                return;
            }

            const { data: profile, error } = await supabase
                .from("users")
                .select("*")
                .eq("id", userId)
                .maybeSingle();

            if (error || !profile) {
                alert("⚠️ Error loading profile.");
                return;
            }

            username.textContent = profile.first_name || "Unknown";
            profileImg.src = profile.avatar_url || "profile-picture.jpg";

            const storedBanner = localStorage.getItem(`banner_${userId}`);
            if (storedBanner) {
                bannerImg.src = storedBanner;
            }
        }

        profileImg.addEventListener("click", () => {
            if (editing) profilePicUpload.click();
        });

        bannerImg.addEventListener("click", () => {
            if (editing) bannerUpload.click();
        });

        username.addEventListener("click", () => {
            if (editing) {
                const input = document.createElement("input");
                input.type = "text";
                input.value = username.textContent;
                input.id = "username-input";
                username.replaceWith(input);
                input.focus();
            }
        });

        profilePicUpload.addEventListener("change", async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const { data, error } = await supabase.storage
                .from("avatars")
                .upload(`public/${userId}`, file, { upsert: true });

            if (error) {
                alert("❌ Upload failed.");
                return;
            }

            const { publicURL } = supabase.storage.from("avatars").getPublicUrl(`public/${userId}`);
            await supabase.from("users").update({ avatar_url: publicURL }).eq("id", userId);
            profileImg.src = publicURL;
        });

        bannerUpload.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                localStorage.setItem(`banner_${userId}`, reader.result);
                bannerImg.src = reader.result;
            };
            reader.readAsDataURL(file);
        });

        editButton.addEventListener("click", async () => {
            if (!editing) {
                editing = true;
                editButton.textContent = "Save";
            } else {
                editing = false;
                editButton.textContent = "Edit";

                const usernameInput = document.getElementById("username-input");
                if (usernameInput) {
                    const newName = usernameInput.value;
                    await supabase.from("users").update({ first_name: newName }).eq("id", userId);
                    usernameInput.replaceWith(username);
                    username.textContent = newName;
                }
            }
        });

        fetchProfile();
    </script>

</body>
</html>
