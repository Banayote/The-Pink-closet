<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Product</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/dist/umd/supabase.js"></script>
</head>
<body>
  <header>
    <h1>Add a New Product</h1>
  </header>
  <main>
    <form id="add-product-form">
      <label for="product-name">Product Name:</label>
      <input type="text" id="product-name" required />

      <label for="product-description">Description:</label>
      <textarea id="product-description" required></textarea>

      <label for="product-price">Price:</label>
      <input type="number" id="product-price" step="0.01" required />

      <label for="product-category">Category:</label>
      <input type="text" id="product-category" required />

      <label for="product-image">Image:</label>
      <input type="file" id="product-image" accept="image/*" required />

      <button type="submit">Add Product</button>
    </form>
  </main>

  <script>
    // âœ… Move Supabase initialization outside event listener
    const supabaseUrl = "https://eczpdpysryifkekieloc.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjenBkcHlzcnlpZmtla2llbG9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIwMjQ2NDUsImV4cCI6MjA0NzYwMDY0NX0.lxC6cqnwH9hMbGC4AsE5W6JRt34eyp4MxhNtAl0MdM4";

    console.log("Using Supabase URL:", supabaseUrl);
    
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    console.log("Supabase initialized successfully.");

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("add-product-form").addEventListener("submit", async (event) => {
        event.preventDefault();

        const productName = document.getElementById("product-name").value.trim();
        const productDescription = document.getElementById("product-description").value.trim();
        const productPrice = parseFloat(document.getElementById("product-price").value);
        const productCategory = document.getElementById("product-category").value.trim();
        const productImage = document.getElementById("product-image").files[0];

        if (!productImage) {
          alert("Please select an image.");
          return;
        }

        const userId = new URLSearchParams(window.location.search).get("user_id");
        if (!userId) {
          alert("User ID not found.");
          return;
        }

        try {
          const { data: imageData, error: imageError } = await supabase.storage
            .from("product-images")
            .upload(`products/${Date.now()}_${productImage.name}`, productImage);

          if (imageError) {
            console.error("Image upload error:", imageError);
            alert("Failed to upload image.");
            return;
          }

          const imageUrl = `${supabaseUrl}/storage/v1/object/public/product-images/${imageData.path}`;
          console.log("Image uploaded successfully:", imageUrl);

          const product = {
            name: productName,
            description: productDescription,
            price: productPrice,
            category: productCategory,
            user_id: userId,
            image_url: imageUrl,
          };

          const { data, error } = await supabase.from("products").insert([product]);

          if (error) {
            console.error("Error adding product:", error);
            alert("Failed to add product.");
            return;
          }

          console.log("Product added successfully:", data);
          alert("Product added successfully!");
          event.target.reset();
        } catch (error) {
          console.error("Error:", error);
          alert("An error occurred.");
        }
      });
    });
  </script>
</body>
</html>
