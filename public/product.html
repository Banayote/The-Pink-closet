<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f8f8; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; }
        img { width: 100%; border-radius: 8px; }
        .details { margin-top: 10px; }
        .price { font-size: 1.2em; font-weight: bold; color: #e60023; }
        button { display: block; width: 100%; padding: 10px; margin-top: 10px; border: none; background-color: #ff4081; color: white; font-size: 1.2em; cursor: pointer; border-radius: 5px; }
        button:hover { background-color: #e60073; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="product-name">Loading...</h1>
        <img id="product-image" src="" alt="Product Image">
        <div class="details">
            <p id="product-description"></p>
            <p class="price" id="product-price"></p>
            <button id="buy-button">Buy</button>
        </div>
    </div>

    <script>
        // ✅ Initialize Supabase
        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ✅ Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product_id');

        if (!productId) {
            alert("❌ Product ID is missing in the URL.");
            throw new Error("❌ Missing product_id in URL.");
        }

        // ✅ Fetch product details
        async function fetchProductDetails() {
            try {
                const { data, error } = await supabaseClient
                    .from("products")
                    .select("*")
                    .eq("id", productId)
                    .single();

                if (error) {
                    console.error("❌ Supabase Error:", error);
                    alert("❌ Failed to fetch product details.");
                    return;
                }

                if (!data) {
                    alert("❌ No product found with this ID.");
                    return;
                }

                // ✅ Update the page with product info
                document.getElementById("product-name").textContent = data.name;
                document.getElementById("product-image").src = data.image_url;
                document.getElementById("product-description").textContent = data.description;
                document.getElementById("product-price").textContent = `$${data.price}`;

                // ✅ Set up the Buy button to start a conversation
                document.getElementById("buy-button").addEventListener("click", () => {
                    if (!data.seller_id) {
                        alert("❌ Seller ID is missing for this product.");
                        return;
                    }
                    window.location.href = `messages.html?seller_id=${encodeURIComponent(data.seller_id)}`;
                });

            } catch (err) {
                console.error("❌ Error:", err);
                alert("❌ An error occurred while fetching the product.");
            }
        }

        fetchProductDetails();
    </script>
</body>
</html>
