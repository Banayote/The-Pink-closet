<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Display</title>
    <!-- Add Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [Keep ALL your existing CSS styles here - they remain unchanged] */
        /* ... your full existing CSS ... */
    </style>
</head>
<body>
    <!-- [Keep ALL your existing HTML structure] -->
    <div class="fixed-header">
        <!-- ... your existing header ... -->
    </div>

    <div class="product-container" id="productContainer">
        <!-- This will be populated dynamically by JavaScript -->
        <p>Loading product...</p>
    </div>

    <!-- [Keep ALL your existing "more products" sections] -->
    <!-- ... -->

    <button class="add-to-closet" id="addToCloset">Add to Closet</button>

    <script>
        // ✅ Supabase Setup
        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUserId = localStorage.getItem("user_id");
        let product; // Store the loaded product

        // ✅ Load Product Data
        document.addEventListener("DOMContentLoaded", async () => {
            // Get product ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                document.getElementById("productContainer").innerHTML = "<p>❌ Product ID missing</p>";
                return;
            }

            // Fetch product from Supabase
            const { data, error } = await supabase
                .from("products")
                .select("*")
                .eq("id", productId)
                .single();

            if (error || !data) {
                document.getElementById("productContainer").innerHTML = "<p>❌ Failed to load product</p>";
                return;
            }

            product = data;
            renderProduct();
            setupEventListeners();
        });

        // ✅ Render Product
        function renderProduct() {
            document.getElementById("productContainer").innerHTML = `
                <div class="image-carousel" id="imageCarousel">
                    <img src="${product.image_url || 'placeholder.jpg'}" alt="${product.name}">
                </div>
                <div class="product-details">
                    <h2 class="product-title">${product.name}</h2>
                    <p class="product-price">$${parseFloat(product.price).toFixed(2)}</p>
                    <div class="product-description">
                        <p>${product.description}</p>
                    </div>
                    <div class="size-options-container">
                        <div class="size-options">
                            ${['XS', 'S', 'M', 'L', 'XL'].map(size => 
                                `<button>${size}</button>`
                            ).join('')}
                        </div>
                    </div>
                    <button class="buy-button" id="buyNow">Buy Now</button>
                    <button class="visit-store" id="messageSeller">Message Seller</button>
                    <button class="review-button" id="leaveReviewButton">Leave a Review</button>
                </div>
            `;
        }

        // ✅ Message Seller Functionality
        async function startConversation() {
            if (!product || !product.seller_id) {
                alert("❌ Seller information missing");
                return;
            }

            // Ensure user ID exists
            if (!currentUserId) {
                currentUserId = "user_" + Math.random().toString(36).substr(2, 9);
                localStorage.setItem("user_id", currentUserId);
            }

            const sellerId = product.seller_id;

            // Check if conversation exists
            const { data: conversation, error } = await supabase
                .from("conversations")
                .select("id")
                .or(`buyer_id.eq.${currentUserId},seller_id.eq.${currentUserId}`)
                .or(`buyer_id.eq.${sellerId},seller_id.eq.${sellerId}`)
                .single();

            // Create new conversation if needed
            const conversationId = conversation?.id || (
                await supabase
                    .from("conversations")
                    .insert([{ buyer_id: currentUserId, seller_id: sellerId }])
                    .select()
                    .single()
            ).data.id;

            window.location.href = `messages.html?conversation_id=${conversationId}`;
        }

        // ✅ Setup Event Listeners
        function setupEventListeners() {
            // Message Seller Button
            document.getElementById("messageSeller")?.addEventListener("click", startConversation);

            // [Keep ALL your existing event listeners]
            document.getElementById("addToCloset")?.addEventListener("click", function() {
                // ... your existing addToCloset logic ...
            });

            document.getElementById("closetIcon")?.addEventListener("click", function() {
                window.location.href = 'closet.html';
            });

            // [Keep your existing carousel and other functionality]
            // ... your existing image carousel code ...
        }

        // [Keep ALL your existing product carousel and "more products" JavaScript]
        // ... your existing moreProductsData, otherProductsData code ...
    </script>
</body>
</html>
