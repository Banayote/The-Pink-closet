<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/dist/supabase.min.js"></script>
</head>
<body>

    <h1>Product Details</h1>
    <div id="product-container"></div>

    <script>
        // ✅ Initialize Supabase
        const SUPABASE_URL = 'https://fjlqkjwnelkamealhtyr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ✅ Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            alert('Product ID is missing.');
        } else {
            loadProduct(productId);
        }

        // ✅ Fetch Product Details
        async function loadProduct(productId) {
            try {
                const { data: product, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .eq('id', productId)
                    .single();

                if (error) throw error;

                document.getElementById('product-container').innerHTML = `
                    <h2>${product.name}</h2>
                    <p>${product.description}</p>
                    <p>Price: $${product.price}</p>
                    <button onclick="startConversation('${product.seller_id}')">Buy</button>
                `;
            } catch (err) {
                console.error('Error fetching product:', err);
                alert('Failed to load product details.');
            }
        }

        // ✅ Start Conversation
        async function startConversation(sellerId) {
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .insert([{ buyer_id: 'guest', seller_id: sellerId, message: "I'm interested!" }])
                    .select()
                    .single();

                if (error) throw error;

                window.location.href = `messages.html?conversation_id=${data.id}`;
            } catch (err) {
                console.error('Error starting conversation:', err);
                alert('Error starting conversation.');
            }
        }
    </script>

</body>
</html>
