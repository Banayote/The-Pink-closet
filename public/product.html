<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Display</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Keep ALL your existing CSS styles below -->
    <style>
        /* [ALL YOUR EXISTING STYLES REMAIN UNCHANGED] */
        body { font-family: Arial, sans-serif; background-color: white; margin: 0; padding: 0; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background-color: white; padding: 5px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1); z-index: 1000; }
        /* ... continue all your existing styles ... */
    </style>
</head>
<body>
    <div class="fixed-header">
        <!-- Keep your header structure -->
        <button class="back-button">&lt;</button>
        <div class="logo">
            <h1>Pink Closet</h1>
        </div>
        <div class="closet-icon-wrapper">
            <!-- Keep closet icon -->
        </div>
    </div>

    <!-- Updated Product Container -->
    <div class="product-container" id="productContainer">
        <p>Loading product...</p>
    </div>

    <!-- Keep all your existing product sections -->
    <div class="more-products-container">
        <!-- ... -->
    </div>

    <button class="add-to-closet" id="addToCloset">Add to Closet</button>

    <script>
        // ============== SUPABASE SETUP ==============
        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUserId = localStorage.getItem("user_id");
        let product;

        // ============== PRODUCT LOADING ==============
        document.addEventListener("DOMContentLoaded", async () => {
            // Get product ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                document.getElementById("productContainer").innerHTML = "<p>❌ Product ID missing</p>";
                return;
            }

            // Fetch product from Supabase
            const { data, error } = await supabase
                .from("products")
                .select("*")
                .eq("id", productId)
                .single();

            if (error || !data) {
                document.getElementById("productContainer").innerHTML = "<p>❌ Failed to load product</p>";
                return;
            }

            product = data;
            renderProduct();
            initializeCarousel();
            setupEventListeners();
        });

        // ============== RENDER PRODUCT ==============
        function renderProduct() {
            document.getElementById("productContainer").innerHTML = `
                <div class="image-carousel" id="imageCarousel">
                    ${product.images.map(img => `<img src="${img}" alt="${product.name}">`).join('')}
                </div>
                <div class="product-details">
                    <h2 class="product-title">${product.name}</h2>
                    <p class="product-price">$${parseFloat(product.price).toFixed(2)}</p>
                    <div class="product-description">
                        <p>${product.description}</p>
                    </div>
                    <div class="size-options-container">
                        <div class="size-options">
                            ${product.sizes.map(size => 
                                `<button>${size}</button>`
                            ).join('')}
                        </div>
                    </div>
                    <button class="buy-button">Buy Now</button>
                    <button class="visit-store" id="messageSeller">Message Seller</button>
                    <button class="review-button" id="leaveReviewButton">Leave a Review</button>
                </div>
            `;
        }

        // ============== MESSAGE SELLER FUNCTION ==============
        async function startConversation() {
            if (!product?.seller_id) {
                alert("❌ Seller information missing");
                return;
            }

            // Create user ID if missing
            if (!currentUserId) {
                currentUserId = "user_" + Math.random().toString(36).substr(2, 9);
                localStorage.setItem("user_id", currentUserId);
            }

            const sellerId = product.seller_id;

            try {
                // Check existing conversation
                const { data: conversation, error } = await supabase
                    .from("conversations")
                    .select("id")
                    .or(`buyer_id.eq.${currentUserId},seller_id.eq.${currentUserId}`)
                    .or(`buyer_id.eq.${sellerId},seller_id.eq.${sellerId}`)
                    .single();

                // Create new conversation if needed
                const convId = conversation?.id || (await supabase
                    .from("conversations")
                    .insert([{ 
                        buyer_id: currentUserId, 
                        seller_id: sellerId,
                        product_id: product.id
                    }])
                    .select()
                    .single()).data.id;

                window.location.href = `messages.html?conversation_id=${convId}`;
            } catch (error) {
                console.error("Conversation error:", error);
                alert("❌ Error starting conversation");
            }
        }

        // ============== PRESERVE EXISTING FUNCTIONALITY ==============
        function initializeCarousel() {
            // Keep all your existing carousel code
            const imageCarousel = document.getElementById('imageCarousel');
            const images = imageCarousel.querySelectorAll('img');
            let currentIndex = 0;
            
            function showImage(index) { /* ... */ }
            function nextImage() { /* ... */ }
            function previousImage() { /* ... */ }
            
            // Keep touch handlers
            imageCarousel.addEventListener('touchstart', (e) => { /* ... */ });
            imageCarousel.addEventListener('touchend', (e) => { /* ... */ });
            
            showImage(currentIndex);
        }

        function setupEventListeners() {
            // Message Seller
            document.getElementById('messageSeller')?.addEventListener('click', startConversation);
            
            // Preserve Add to Closet
            document.getElementById('addToCloset')?.addEventListener('click', () => {
                // Keep your existing animation and localStorage logic
                // ...
            });

            // Preserve all other existing listeners
            document.getElementById('closetIcon')?.addEventListener('click', () => {
                window.location.href = 'closet.html';
            });

            document.getElementById('leaveReviewButton')?.addEventListener('click', () => {
                window.location.href = 'reviews.html';
            });
        }

        // Keep your existing more products logic
        const moreProductsData = [/* ... */];
        // ... rest of your existing product display code ...
    </script>
</body>
</html>
