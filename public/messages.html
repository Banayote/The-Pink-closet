<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>

    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm";

        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener("DOMContentLoaded", () => {
            const messageForm = document.getElementById("message-form");
            const conversationId = new URLSearchParams(window.location.search).get("conversation_id");
            const buyerId = new URLSearchParams(window.location.search).get("buyer_id"); // Assuming buyer_id is passed in the URL
            const sender = 'buyer'; // This can also be dynamically determined

            if (!buyerId || !conversationId) {
                alert("Error: Missing buyer ID or conversation ID.");
                return;
            }

            messageForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                const messageContent = document.getElementById("message-content").value;
                
                if (!messageContent) {
                    alert("Message content cannot be empty.");
                    return;
                }

                const messageData = {
                    conversation_id: conversationId,
                    message: messageContent,
                    sender: sender, // Can be either 'buyer' or 'seller', based on the sender's identity
                    buyer_id: buyerId, // Include the buyer ID here
                    timestamp: new Date().toISOString(),
                };

                try {
                    const { data, error } = await supabase.from('messages').insert([messageData]);

                    if (error) {
                        console.error('Error sending message:', error);
                        alert("Error sending message: " + error.message);
                    } else {
                        console.log('Message sent:', data);
                        alert("Message sent successfully!");
                        document.getElementById("message-content").value = ''; // Reset message input
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("An error occurred: " + error.message);
                }
            });
        });
    </script>
</head>
<body>
    <h1>Messages</h1>
    <form id="message-form">
        <textarea id="message-content" placeholder="Type your message here..." required></textarea>
        <button type="submit">Send Message</button>
    </form>
</body>
</html>
