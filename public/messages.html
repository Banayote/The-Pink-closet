<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>

    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm";

        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener("DOMContentLoaded", async () => {
            const messageForm = document.getElementById("message-form");
            const messageContainer = document.getElementById("messages-container");
            const urlParams = new URLSearchParams(window.location.search);
            
            const buyerId = urlParams.get("buyer_id");
            const sellerId = urlParams.get("seller_id"); // Added seller_id to ensure correct messaging
            let conversationId = urlParams.get("conversation_id");

            if (!buyerId || !sellerId) {
                alert("Error: Missing buyer ID or seller ID.");
                return;
            }

            // ✅ If conversation_id is missing, find or create a conversation
            if (!conversationId) {
                const { data: existingConversations, error } = await supabase
                    .from("conversations")
                    .select("id")
                    .eq("buyer_id", buyerId)
                    .eq("seller_id", sellerId)
                    .single();
                
                if (error && error.code !== "PGRST116") { // Ignore 'no rows found' error
                    console.error("Error checking conversation:", error);
                    alert("Failed to check conversation: " + error.message);
                    return;
                }

                if (existingConversations) {
                    conversationId = existingConversations.id;
                } else {
                    // ✅ Create a new conversation if one doesn't exist
                    const { data: newConversation, error: newConversationError } = await supabase
                        .from("conversations")
                        .insert([{ buyer_id: buyerId, seller_id: sellerId }])
                        .select("id")
                        .single();

                    if (newConversationError) {
                        console.error("Error creating conversation:", newConversationError);
                        alert("Failed to create conversation: " + newConversationError.message);
                        return;
                    }

                    conversationId = newConversation.id;
                }

                // ✅ Update URL with conversation_id
                window.history.replaceState({}, "", `?conversation_id=${conversationId}&buyer_id=${buyerId}&seller_id=${sellerId}`);
            }

            // ✅ Load messages for this conversation
            async function loadMessages() {
                const { data: messages, error } = await supabase
                    .from("messages")
                    .select("*")
                    .eq("conversation_id", conversationId)
                    .order("timestamp", { ascending: true });

                if (error) {
                    console.error("Error loading messages:", error);
                    alert("Error loading messages: " + error.message);
                    return;
                }

                messageContainer.innerHTML = "";
                messages.forEach(msg => {
                    const messageElement = document.createElement("div");
                    messageElement.textContent = `${msg.sender}: ${msg.message}`;
                    messageContainer.appendChild(messageElement);
                });
            }

            await loadMessages();

            // ✅ Handle sending messages
            messageForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                const messageContent = document.getElementById("message-content").value.trim();
                if (!messageContent) {
                    alert("Message cannot be empty.");
                    return;
                }

                const messageData = {
                    conversation_id: conversationId,
                    message: messageContent,
                    sender: "buyer", // You can change this dynamically
                    buyer_id: buyerId,
                    seller_id: sellerId, // ✅ Ensure seller_id is included
                    timestamp: new Date().toISOString(),
                };

                const { error } = await supabase.from("messages").insert([messageData]);

                if (error) {
                    console.error("Error sending message:", error);
                    alert("Error sending message: " + error.message);
                } else {
                    document.getElementById("message-content").value = "";
                    await loadMessages(); // Reload messages after sending
                }
            });

            // ✅ Real-time message updates
            supabase.channel("messages")
                .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, loadMessages)
                .subscribe();
        });
    </script>
</head>
<body>
    <h1>Messages</h1>
    <div id="messages-container"></div>
    <form id="message-form">
        <textarea id="message-content" placeholder="Type your message here..." required></textarea>
        <button type="submit">Send Message</button>
    </form>
</body>
</html>
