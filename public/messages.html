<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <link rel="stylesheet" href="messages.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            text-align: center;
        }
        .chat-container {
            width: 80%;
            max-width: 500px;
            margin: 20px auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
            text-align: left;
        }
        .message-input {
            width: 80%;
            padding: 10px;
        }
        .send-button {
            padding: 10px;
            background-color: blue;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <h2>Chat</h2>
        <div id="messages-container" class="messages">Loading messages...</div>
        <input type="text" id="message-input" class="message-input" placeholder="Type a message...">
        <button id="send-message" class="send-button">Send</button>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm";

        console.log("üîµ Initializing Supabase...");

        // ‚úÖ Supabase credentials
        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        console.log("‚úÖ Supabase initialized.");

        // ‚úÖ Get conversation ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get("conversation_id");

        console.log("üì¢ Conversation ID:", conversationId);

        if (!conversationId) {
            alert("‚ö†Ô∏è No conversation ID found! Redirecting...");
            window.location.href = "index.html";
        }

        // ‚úÖ Get user ID from LocalStorage
        const userId = localStorage.getItem("user_id");
        console.log("üÜî User ID:", userId);

        if (!userId) {
            alert("‚ö†Ô∏è No user ID found! Please log in.");
            window.location.href = "store.html";
        }

        // ‚úÖ Load messages
        async function loadMessages() {
            console.log("üì© Loading messages...");
            const { data, error } = await supabase
                .from("messages")
                .select("*")
                .eq("conversation_id", conversationId)
                .order("created_at", { ascending: true });

            if (error) {
                console.error("‚ùå Error fetching messages:", error);
                return;
            }

            console.log("‚úÖ Messages loaded:", data);

            const messagesContainer = document.getElementById("messages-container");
            messagesContainer.innerHTML = "";

            if (data.length === 0) {
                messagesContainer.innerHTML = "<p>No messages yet.</p>";
            }

            data.forEach(msg => {
                const div = document.createElement("div");
                div.textContent = `${msg.sender_id}: ${msg.message}`;
                messagesContainer.appendChild(div);
            });
        }

        // ‚úÖ Send message
        async function sendMessage() {
            console.log("üì§ Sending message...");

            const messageInput = document.getElementById("message-input");
            const messageText = messageInput.value.trim();

            if (!messageText) {
                console.warn("‚ö†Ô∏è Message is empty!");
                return;
            }

            const { data, error } = await supabase.from("messages").insert([
                {
                    conversation_id: conversationId,
                    sender_id: userId,
                    message: messageText
                }
            ]);

            if (error) {
                console.error("‚ùå Error sending message:", error);
                return;
            }

            console.log("‚úÖ Message sent:", data);

            messageInput.value = "";
            loadMessages();
        }

        // ‚úÖ Event listener for send button
        document.getElementById("send-message").addEventListener("click", sendMessage);

        // ‚úÖ Load messages when page loads
        window.onload = loadMessages;
    </script>
</body>
</html>

