<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f9f9f9; }
        #messages { padding: 20px; background: white; margin: 20px auto; max-width: 600px; border-radius: 8px; }
        .message { padding: 10px; margin: 5px; border-radius: 5px; }
        .sent { background: #ff6347; color: white; text-align: right; }
        .received { background: #ddd; text-align: left; }
        input { width: 80%; padding: 10px; }
        button { padding: 10px; }
    </style>
</head>
<body>

    <h2>Messages</h2>
    <div id="messages"></div>
    <input type="text" id="messageInput">
    <button onclick="sendMessage()">Send</button>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        console.log("‚úÖ Script Loaded");

        // ‚úÖ Supabase Credentials (YOUR KEYS INCLUDED)
        const SUPABASE_URL = 'https://fjlqkjwnelkamealhtyr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ‚úÖ Get URL Params
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('conversation_id');
        const buyerId = urlParams.get('buyer_id');
        const sellerId = urlParams.get('seller_id');

        if (!conversationId || !buyerId || !sellerId) {
            alert("‚ùå Missing conversation details. Redirecting...");
            window.location.href = "index.html";
        }

        console.log("üìù Conversation ID:", conversationId);
        console.log("üõí Buyer ID:", buyerId);
        console.log("üè™ Seller ID:", sellerId);

        // ‚úÖ Fetch Messages
        async function loadMessages() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('conversation_id', conversationId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = "";

                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.classList.add('message', msg.sender_id === buyerId ? 'sent' : 'received');
                    div.textContent = msg.message;
                    messagesContainer.appendChild(div);
                });

            } catch (err) {
                console.error("‚ùå Error loading messages:", err.message);
            }
        }

        // ‚úÖ Send Message
        async function sendMessage() {
            const messageText = document.getElementById('messageInput').value;
            if (!messageText) return;

            try {
                const { error } = await supabase.from('messages').insert([{
                    conversation_id: conversationId,
                    sender_id: buyerId,
                    receiver_id: sellerId,
                    message: messageText
                }]);

                if (error) throw error;

                document.getElementById('messageInput').value = "";
                loadMessages(); // Refresh messages after sending

            } catch (err) {
                console.error("‚ùå Error sending message:", err.message);
            }
        }

        // ‚úÖ Auto Refresh Messages
        setInterval(loadMessages, 3000); // Refresh every 3 seconds

        document.addEventListener('DOMContentLoaded', loadMessages);
    </script>

</body>
</html>
