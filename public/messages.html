<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        header {
            background-color: #ff6347;
            color: white;
            padding: 10px;
            text-align: center;
        }

        .message-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            border-radius: 8px;
            max-width: 600px;
        }

        .message-container .message {
            background-color: #f1f1f1;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            width: 100%;
        }

        .message-container .message p {
            margin: 0;
        }

        #message-input {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .send-btn {
            background-color: #ff6347;
            color: white;
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            border-radius: 5px;
        }

        .send-btn:hover {
            background-color: #e5533b;
        }
    </style>
</head>

<body>
    <header>
        <h1>Messages</h1>
    </header>

    <main>
        <div id="message-container" class="message-container">
            <p>Loading messages...</p>
        </div>
    </main>

    <footer>
        <p>&copy; The Pink Closet 2024. All rights reserved.</p>
    </footer>

    <!-- Load Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        console.log("✅ Script Loaded");

        // ✅ Initialize Supabase
        const SUPABASE_URL = 'https://fjlqkjwnelkamealhtyr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("✅ Page loaded, fetching messages...");

            // Get conversation_id and product_id from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const conversationId = urlParams.get('conversation_id');
            const productId = urlParams.get('product_id');  // Ensure product_id is passed correctly
            const sellerId = urlParams.get('seller_id');    // Ensure seller_id is passed correctly

            if (!conversationId || !productId || !sellerId) {
                document.getElementById('message-container').innerHTML = '<p>❌ Missing conversation_id, product_id or seller_id in the URL.</p>';
                return;
            }

            try {
                // ✅ Fetch messages associated with this conversation
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('conversation_id', conversationId)
                    .order('created_at', { ascending: true });

                if (error || !messages) {
                    throw error || new Error("Messages not found.");
                }

                // ✅ Display messages
                const messageList = messages.map(message => `
                    <div class="message">
                        <p><strong>${message.sender}</strong>: ${message.message}</p>
                    </div>
                `).join('');

                document.getElementById('message-container').innerHTML = messageList;

            } catch (err) {
                console.error('❌ Error fetching messages:', err.message);
                document.getElementById('message-container').innerHTML = '<p>❌ Failed to load messages.</p>';
            }
        });

        // ✅ Function to send a new message
        async function sendMessage() {
            const messageText = document.getElementById('message-input').value;

            if (!messageText) {
                alert("❌ Message cannot be empty.");
                return;
            }

            // Get conversation_id, product_id, and seller_id from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const conversationId = urlParams.get('conversation_id');
            const productId = urlParams.get('product_id');
            const sellerId = urlParams.get('seller_id');

            if (!conversationId || !productId || !sellerId) {
                alert("❌ Missing conversation_id, product_id or seller_id.");
                return;
            }

            try {
                // ✅ Insert new message into the 'messages' table
                const { data, error } = await supabase
                    .from('messages')
                    .insert([{
                        conversation_id: conversationId,
                        product_id: productId,   // Ensure product_id is included
                        seller_id: sellerId,     // Ensure seller_id is included
                        message: messageText,
                        sender: 'buyer',         // Assuming 'buyer' sends the message
                        created_at: new Date().toISOString()
                    }]);

                if (error) {
                    throw error;
                }

                console.log("✅ Message sent successfully.");
                // Reload messages after sending
                window.location.reload();
            } catch (err) {
                console.error("❌ Error sending message:", err.message);
                alert("❌ Error sending message. Please try again.");
            }
        }
    </script>

    <div>
        <textarea id="message-input" placeholder="Type your message..."></textarea>
        <button class="send-btn" onclick="sendMessage()">Send Message</button>
    </div>

</body>

</html>
