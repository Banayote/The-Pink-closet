<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <link rel="stylesheet" href="messages.css">
</head>
<body>

    <h1>Chat</h1>
    <div id="chat-box"></div>

    <input type="text" id="message-input" placeholder="Type your message...">
    <button id="send-message">Send</button>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
        
        // ✅ Your Supabase Credentials (FULLY ADDED)
        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";
        const supabase = createClient(SUPABASE_URL, SUPABASE_API_KEY);

        // ✅ Get URL parameters
        const params = new URLSearchParams(window.location.search);
        const sellerId = params.get("seller_id");
        const productId = params.get("product_id");
        const buyerId = params.get("buyer_id");

        console.log("Debug:", { sellerId, productId, buyerId });

        if (!sellerId || !productId || !buyerId) {
            alert("❌ Missing required IDs. Cannot load chat.");
            throw new Error("Missing IDs");
        }

        // ✅ Ensure Conversation Exists
        async function createOrGetConversation() {
            const { data: existingConv, error: convError } = await supabase
                .from("conversations")
                .select("*")
                .eq("seller_id", sellerId)
                .eq("buyer_id", buyerId)
                .eq("product_id", productId)
                .single();

            if (convError) {
                console.error("No conversation found, creating a new one...");
                const { data, error } = await supabase.from("conversations").insert([
                    { seller_id: sellerId, buyer_id: buyerId, product_id: productId }
                ]);
                if (error) {
                    console.error("Error creating conversation:", error);
                    return;
                }
                console.log("✅ New conversation created:", data);
            } else {
                console.log("✅ Existing conversation found:", existingConv);
            }
        }

        // ✅ Load Messages
        async function loadMessages() {
            const { data, error } = await supabase
                .from("messages")
                .select("*")
                .eq("seller_id", sellerId)
                .eq("buyer_id", buyerId)
                .eq("product_id", productId)
                .order("created_at", { ascending: true });

            if (error) {
                console.error("Error loading messages:", error);
                return;
            }

            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = "";

            data.forEach(msg => {
                const messageDiv = document.createElement("div");
                messageDiv.textContent = `${msg.sender}: ${msg.message}`;
                chatBox.appendChild(messageDiv);
            });

            console.log("✅ Messages loaded:", data);
        }

        // ✅ Send Message
        document.getElementById("send-message").addEventListener("click", async () => {
            const messageInput = document.getElementById("message-input");
            const messageText = messageInput.value.trim();
            if (!messageText) return;

            const senderId = buyerId || sellerId; // Auto-detect sender

            const { error } = await supabase.from("messages").insert([
                { seller_id: sellerId, buyer_id: buyerId, product_id: productId, message: messageText, sender: senderId }
            ]);

            if (error) {
                console.error("❌ Error sending message:", error);
                return;
            }

            console.log("✅ Message sent!");
            messageInput.value = "";
            loadMessages();
        });

        // ✅ Initialize Chat
        createOrGetConversation().then(loadMessages);
    </script>

</body>
</html>
