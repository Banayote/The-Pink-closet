<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm"></script> 
</head>
<body>

<div>
    <h2>Conversation</h2>
    <div id="messages-container"></div>
    <input type="text" id="message-input" placeholder="Type a message..." />
    <button id="send-message">Send</button>
</div>

<script type="module">
    // ✅ Move Supabase Initialization to the TOP  
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm";

    const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY); // ✅ Now it's defined BEFORE usage

    // Get conversation ID from URL  
    const urlParams = new URLSearchParams(window.location.search);
    const conversationId = urlParams.get("conversation_id");

    if (!conversationId) {
        alert("No conversation ID found!");
        window.location.href = "index.html";
    }

    // Function to load messages
    async function loadMessages() {
        const { data, error } = await supabase
            .from("messages")
            .select("*")
            .eq("conversation_id", conversationId)
            .order("created_at", { ascending: true });

        if (error) {
            console.error("Error fetching messages:", error);
            return;
        }

        const messagesContainer = document.getElementById("messages-container");
        messagesContainer.innerHTML = ""; // Clear old messages

        data.forEach(message => {
            const div = document.createElement("div");
            div.textContent = `${message.sender_id}: ${message.message_text}`;
            messagesContainer.appendChild(div);
        });
    }

    // Function to send message
    async function sendMessage() {
        const messageInput = document.getElementById("message-input");
        const messageText = messageInput.value.trim();
        const userId = localStorage.getItem("user_id");

        if (!messageText || !userId) return;

        const { error } = await supabase.from("messages").insert([
            { conversation_id: conversationId, sender_id: userId, message_text: messageText }
        ]);

        if (error) {
            console.error("Error sending message:", error);
            return;
        }

        messageInput.value = "";
        loadMessages(); // Reload messages
    }

    // Event listener for send button
    document.getElementById("send-message").addEventListener("click", sendMessage);

    // Load messages when page loads
    window.onload = loadMessages;
</script>

</body>
</html>
