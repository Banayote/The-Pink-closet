<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm";

        // ✅ Your Supabase Credentials
        const SUPABASE_URL = "https://fjlqkjwnelkamealhtyr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqbHFranduZWxrYW1lYWxodHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMDUyMDYsImV4cCI6MjA1Mjc4MTIwNn0.WOvuaxbIyDPyAp8mk7-ebhB6QdNI8EXbycA9XEg-US4";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener("DOMContentLoaded", async () => {
            console.log("✅ Page loaded.");

            // 🔍 Get the logged-in user
            const { data: userData, error: userError } = await supabase.auth.getUser();
            if (userError || !userData.user) {
                alert("❌ You must be logged in to send messages.");
                return;
            }

            const userId = userData.user.id;
            console.log("🔍 Logged-in User ID:", userId);

            // 🔍 Extract other user's ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            let otherUserId = urlParams.get("other_user_id");

            if (!otherUserId) {
                alert("❌ No recipient found. Please select a chat.");
                return;
            }

            console.log("🔍 Chatting with User ID:", otherUserId);

            const messageForm = document.getElementById("message-form");
            const messageContainer = document.getElementById("messages-container");

            // ✅ Load Messages
            async function loadMessages() {
                console.log("ℹ️ Loading messages between", userId, "and", otherUserId);

                const { data: messages, error } = await supabase
                    .from("messages")
                    .select("*")
                    .or(`buyer_id.eq.${userId},seller_id.eq.${userId}`)
                    .or(`buyer_id.eq.${otherUserId},seller_id.eq.${otherUserId}`)
                    .order("timestamp", { ascending: true });

                if (error) {
                    console.error("❌ Error loading messages:", error);
                    return;
                }

                messageContainer.innerHTML = "";
                messages.forEach(msg => {
                    const messageElement = document.createElement("div");
                    messageElement.textContent = `${msg.sender}: ${msg.message}`;
                    messageContainer.appendChild(messageElement);
                });
            }

            await loadMessages();

            // ✅ Send Message
            messageForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                const messageContent = document.getElementById("message-content").value.trim();
                if (!messageContent) {
                    alert("❌ Message cannot be empty.");
                    return;
                }

                const messageData = {
                    buyer_id: userId,
                    seller_id: otherUserId,
                    message: messageContent,
                    sender: userId,
                    timestamp: new Date().toISOString(),
                };

                console.log("📤 Sending message:", messageData);

                const { error } = await supabase.from("messages").insert([messageData]);

                if (error) {
                    console.error("❌ Error sending message:", error);
                    alert("Error sending message: " + error.message);
                } else {
                    console.log("✅ Message sent successfully!");
                    document.getElementById("message-content").value = "";
                    await loadMessages();
                }
            });

            // ✅ Real-time Message Updates
            supabase.channel("messages")
                .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, loadMessages)
                .subscribe();
        });
    </script>
</head>
<body>
    <h1>Messages</h1>
    <div id="messages-container"></div>
    <form id="message-form">
        <textarea id="message-content" placeholder="Type your message here..." required></textarea>
        <button type="submit">Send Message</button>
    </form>
</body>
</html>
